{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <!-- Streak Display -->
    {% if streak %}
    <div class="row justify-content-center mb-4">
        <div class="col-auto">
            <div class="streak-display text-center">
                <div class="streak-icon mb-2">
                    ðŸ”¥
                </div>
                <div class="streak-info">
                    <div class="current-streak">Day {{ streak.current_streak }}</div>
                    <div class="text-muted small">Best: {{ streak.highest_streak }}</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Daily Quote -->
    {% if quote %}
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <div class="quote-card">
                <div class="quote-content">
                    <i class="fas fa-quote-left quote-icon"></i>
                    <blockquote class="quote-text">
                        {{ quote.text }}
                    </blockquote>
                    <div class="quote-author">
                        â€” {{ quote.author }}
                    </div>
                    {% if quote.tags %}
                    <div class="quote-tags mt-3">
                        {% for tag in quote.tags.split(',') %}
                        <span class="badge bg-secondary me-1">{{ tag.strip() }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Action Buttons -->
                <div class="quote-actions mt-4">
                    <div class="row g-2">
                        <div class="col-12 col-sm-6">
                            {% if not is_saved %}
                            <form method="POST" action="{{ url_for('save_quote') }}" class="d-inline">
                                <input type="hidden" name="quote_id" value="{{ quote.id }}">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-heart me-1"></i>Save to Journal
                                </button>
                            </form>
                            {% else %}
                            <a href="{{ url_for('journal') }}" class="btn btn-success w-100">
                                <i class="fas fa-check me-1"></i>Saved in Journal
                            </a>
                            {% endif %}
                        </div>
                        <div class="col-12 col-sm-6">
                            <button type="button" class="btn btn-outline-primary w-100" id="explainBtn" 
                                    data-quote-id="{{ quote.id }}">
                                <i class="fas fa-lightbulb me-1"></i>Explain Quote
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Explanation Section -->
                <div id="explanationSection" class="mt-4" style="display: none;">
                    <div class="explanation-content">
                        <h5 class="mb-3">
                            <i class="fas fa-brain me-2"></i>AI Explanation
                        </h5>
                        <div id="explanationText" class="explanation-text"></div>
                        
                        <!-- Chat Section -->
                        <div class="chat-section mt-4">
                            <h6 class="mb-3">
                                <i class="fas fa-comments me-2"></i>Continue the Conversation
                            </h6>
                            <div id="chatHistory" class="chat-history mb-3"></div>
                            <form id="chatForm" class="chat-form">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="chatInput" 
                                           placeholder="Ask a question or share your thoughts...">
                                    <button type="submit" class="btn btn-outline-primary">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6 text-center">
            <div class="empty-state">
                <i class="fas fa-quote-left fa-3x text-muted mb-3"></i>
                <h3>No quotes available</h3>
                <p class="text-muted">
                    There are no philosophical quotes in the database yet. 
                    Please contact an administrator to add some quotes.
                </p>
                {% if session.admin_authenticated %}
                <a href="{{ url_for('admin') }}" class="btn btn-primary">
                    <i class="fas fa-cog me-1"></i>Go to Admin Panel
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const explainBtn = document.getElementById('explainBtn');
    const explanationSection = document.getElementById('explanationSection');
    const explanationText = document.getElementById('explanationText');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatHistory = document.getElementById('chatHistory');
    
    let isExplanationVisible = false;
    
    if (explainBtn) {
        explainBtn.addEventListener('click', function() {
            if (!isExplanationVisible) {
                const quoteId = this.dataset.quoteId;
                getExplanation(quoteId);
            } else {
                toggleExplanationSection();
            }
        });
    }
    
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message) {
                sendChatMessage(message);
                chatInput.value = '';
            }
        });
    }
    
    function getExplanation(quoteId) {
        explainBtn.disabled = true;
        explainBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Getting explanation...';
        
        const formData = new FormData();
        formData.append('quote_id', quoteId);
        
        fetch('/explain_quote', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.explanation) {
                explanationText.innerHTML = data.explanation;
                showExplanationSection();
            } else {
                alert('Error getting explanation: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error getting explanation');
        })
        .finally(() => {
            explainBtn.disabled = false;
            explainBtn.innerHTML = isExplanationVisible ? 
                '<i class="fas fa-eye-slash me-1"></i>Hide Explanation' : 
                '<i class="fas fa-lightbulb me-1"></i>Explain Quote';
        });
    }
    
    function sendChatMessage(message) {
        const quoteId = explainBtn.dataset.quoteId;
        
        // Add user message to chat
        addChatMessage(message, 'user');
        
        // Show loading
        const loadingDiv = addChatMessage('Thinking...', 'assistant', true);
        
        const formData = new FormData();
        formData.append('quote_id', quoteId);
        formData.append('message', message);
        
        fetch('/chat', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Remove loading message
            if (loadingDiv) {
                loadingDiv.remove();
            }
            
            if (data.ai_response) {
                addChatMessage(data.ai_response, 'assistant');
            } else {
                addChatMessage('Error: ' + (data.error || 'Unknown error'), 'assistant');
            }
        })
        .catch(error => {
            if (loadingDiv) {
                loadingDiv.remove();
            }
            console.error('Error:', error);
            addChatMessage('Error sending message', 'assistant');
        });
    }
    
    function addChatMessage(message, sender, isLoading = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}-message mb-2`;
        
        const icon = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
        const bgClass = sender === 'user' ? 'bg-primary' : 'bg-secondary';
        
        messageDiv.innerHTML = `
            <div class="d-flex ${sender === 'user' ? 'justify-content-end' : ''}">
                <div class="message-bubble ${bgClass} text-white p-2 rounded" style="max-width: 80%;">
                    <i class="${icon} me-1"></i>
                    ${message}
                </div>
            </div>
        `;
        
        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        
        return isLoading ? messageDiv : null;
    }
    
    function showExplanationSection() {
        explanationSection.style.display = 'block';
        isExplanationVisible = true;
        explainBtn.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Explanation';
    }
    
    function toggleExplanationSection() {
        if (isExplanationVisible) {
            explanationSection.style.display = 'none';
            isExplanationVisible = false;
            explainBtn.innerHTML = '<i class="fas fa-lightbulb me-1"></i>Explain Quote';
        } else {
            explanationSection.style.display = 'block';
            isExplanationVisible = true;
            explainBtn.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Explanation';
        }
    }
});
</script>
{% endblock %}
